<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // DEINE KONFIGURATION (lkw-trackerneu)
    const firebaseConfig = {
        apiKey: "AIzaSyDjBsp7utlNUw4wgHsQ0yznV7ioaqY76OQ",
        authDomain: "lkw-trackerneu.firebaseapp.com",
        databaseURL: "https://lkw-trackerneu-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lkw-trackerneu",
        storageBucket: "lkw-trackerneu.firebasestorage.app",
        messagingSenderId: "335563014230",
        appId: "1:335563014230:web:284080c578f89595993bf7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Status setzen
    const statusEl = document.getElementById('status-indicator');
    statusEl.textContent = "üü¢ ONLINE (System bereit)";
    statusEl.style.color = "#10b981";

    let lkwLog = [];
    let lkwPlan = [];
    let myChart = null;
    const EMAIL_RECIPIENT = "alexander.kellner@haertecenter.de";

    // --- DATEN LADEN ---
    onValue(ref(db, 'logs'), (snapshot) => {
        lkwLog = [];
        const data = snapshot.val();
        if(data) Object.keys(data).forEach(k => lkwLog.push({ id: k, ...data[k] }));
        renderAll();
    }, (error) => {
        statusEl.textContent = "üî¥ FEHLER: " + error.code;
        statusEl.style.color = "red";
        alert("Datenbank-Fehler (Lesen): " + error.message + "\n\nBitte 'Regeln' in Firebase pr√ºfen!");
    });

    onValue(ref(db, 'plans'), (snapshot) => {
        lkwPlan = [];
        const data = snapshot.val();
        if(data) Object.keys(data).forEach(k => lkwPlan.push({ id: k, ...data[k] }));
        renderAll();
    });

    // --- INIT ---
    setNow('logTime');
    initTimeSelects();
    initChart();
    document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('dateDisplayToday').textContent = new Date().toLocaleDateString('de-DE');

    // --- FUNKTIONEN (Mit Fehlermeldung) ---
    window.addLog = (e) => {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        entry.departureTime = null; 
        entry.duration = null;
        
        push(ref(db, 'logs'), entry)
            .then(() => {
                // Erfolg!
                document.getElementById('logForm').reset();
                setNow('logTime');
            })
            .catch((error) => {
                alert("FEHLER beim Speichern:\n" + error.message + "\n\nBitte pr√ºfe die Datenbank-Regeln auf 'true'.");
            });
    };

    window.addPlan = (e) => {
        e.preventDefault();
        const entry = getFormData('plan');
        entry.date = document.getElementById('planDate').value;
        
        push(ref(db, 'plans'), entry)
            .then(() => {
                document.getElementById('planForm').reset();
                document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('planHour').value = "08";
                document.getElementById('planMinute').value = "00";
                window.updatePlanTime();
            })
            .catch((error) => {
                alert("FEHLER beim Planen:\n" + error.message);
            });
    };

    window.setDeparture = (id) => {
        const item = lkwLog.find(x => x.id === id);
        if(item) {
            const nowTime = new Date().toTimeString().substring(0,5);
            const duration = calculateDuration(item.time, nowTime);
            update(ref(db, 'logs/' + id), { departureTime: nowTime, duration: duration })
                .catch(err => alert("Fehler: " + err.message));
        }
    };

    window.checkIn = (id) => {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;
        const now = new Date();
        const timeStr = now.toTimeString().substring(0,5);
        const logEntry = {
            ...item, date: now.toISOString().split('T')[0], time: timeStr, shift: calculateShift(timeStr),
            departureTime: null, duration: null
        };
        push(ref(db, 'logs'), logEntry)
            .then(() => remove(ref(db, 'plans/' + id)))
            .catch(err => alert("Fehler beim Check-In: " + err.message));
    };

    window.deleteLog = (id) => { if(confirm("L√∂schen?")) remove(ref(db, 'logs/' + id)).catch(err => alert(err.message)); };
    window.deletePlan = (id) => { if(confirm("L√∂schen?")) remove(ref(db, 'plans/' + id)).catch(err => alert(err.message)); };
    window.sendLateMail = (id) => { location.href = `mailto:${EMAIL_RECIPIENT}?subject=Verzug&body=LKW √ºberf√§llig`; };
    
    // --- HELPER ---
    window.updatePlanTime = () => {
        const h = document.getElementById('planHour').value;
        const m = document.getElementById('planMinute').value;
        document.getElementById('planTime').value = `${h}:${m}`;
    };
    window.renderLogTable = () => { renderLogTableInternal(); };
    window.exportToCSV = () => {
        let csv = "Datum;Ankunft;Abfahrt;Dauer;Spedition;Kennzeichen;Ware;Typ\n";
        lkwLog.forEach(r => csv += `${r.date};${r.time};${r.departureTime||'-'};${r.duration||'-'};${r.spedition};${r.plate};${r.ware};${r.type}\n`);
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        link.download = `LKW_Export_${new Date().toLocaleDateString()}.csv`;
        link.click();
    };

    // --- INTERNALS & RENDERING ---
    document.getElementById('logForm').addEventListener('submit', window.addLog);
    document.getElementById('planForm').addEventListener('submit', window.addPlan);

    function initTimeSelects() {
        const hourSelect = document.getElementById('planHour');
        for(let i=0; i<24; i++) {
            const val = i.toString().padStart(2,'0');
            const opt = document.createElement('option'); opt.value=val; opt.text=val+' Uhr';
            if(i===8) opt.selected=true;
            hourSelect.appendChild(opt);
        }
        window.updatePlanTime();
    }

    function renderAll() { renderLogTableInternal(); renderPlanTables(); calculateStats(); updateChart(); }

    function renderLogTableInternal() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        
        const sorted = [...lkwLog].sort((a,b) => b.time.localeCompare(a.time));

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return;
            const searchString = `${entry.spedition} ${entry.plate} ${entry.ware} ${entry.type}`.toLowerCase();
            if(searchText && !searchString.includes(searchText)) return;

            const badge = entry.type === 'Anlieferung' ? 'in' : 'out';
            const tr = document.createElement('tr');
            
            let statusContent = '';
            if (entry.departureTime) {
                tr.className = 'row-finished';
                statusContent = `‚úÖ <strong>${entry.duration}</strong> <br><span style="font-size:0.8em">Ab: ${entry.departureTime}</span>`;
            } else {
                statusContent = `<button onclick="setDeparture('${entry.id}')" class="btn btn-done btn-small">Abfertigen ‚è±Ô∏è</button>`;
            }

            tr.innerHTML = `<td><strong>${entry.time}</strong></td><td><span class="badge ${badge}">${entry.type}</span></td><td>${entry.spedition}</td><td>${entry.plate}</td><td>${statusContent}</td><td><button onclick="deleteLog('${entry.id}')" class="btn btn-danger btn-small">X</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderPlanTables() {
        const tbodyToday = document.querySelector('#planTableToday tbody');
        const tbodyFuture = document.querySelector('#planTableFuture tbody');
        tbodyToday.innerHTML = ''; tbodyFuture.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        const sorted = [...lkwPlan].sort((a,b) => (a.date === b.date) ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date));

        let cT=0;
        sorted.forEach(e => {
            const badge = e.type === 'Anlieferung' ? 'in' : 'out';
            if(e.date === todayStr) {
                cT++;
                const [h, m] = e.time.split(':').map(Number);
                const isLate = curMin > (h*60+m);
                const tr = document.createElement('tr');
                tr.className = isLate ? 'row-overdue' : 'row-planned';
                let btn = isLate 
                    ? `<button onclick="checkIn('${e.id}')" class="btn btn-success btn-small">Ist da</button>`
                    : `<button onclick="checkIn('${e.id}')" class="btn btn-success btn-small">Ist da</button> <button onclick="deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button>`;
                tr.innerHTML = `<td><strong>${e.time}</strong></td><td>${isLate?'‚ö†Ô∏è':'Geplant'}</td><td><span class="badge ${badge}">${e.type}</span></td><td>${e.spedition}</td><td>${btn}</td>`;
                tbodyToday.appendChild(tr);
            } else if (e.date > todayStr) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${new Date(e.date).toLocaleDateString()}</td><td><span class="badge ${badge}">${e.type}</span></td><td>${e.spedition}</td><td>${e.ware}</td><td><button onclick="deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button></td>`;
                tbodyFuture.appendChild(tr);
            }
        });
        document.getElementById('noTodayMsg').style.display = cT===0?'block':'none';
    }

    function calculateStats() {
        let early=0, late=0, hours={}; const todayStr=new Date().toISOString().split('T')[0];
        lkwLog.forEach(e => {
            if(e.date===todayStr) {
                if(e.shift==='Fr√ºh') early++; if(e.shift==='Sp√§t') late++;
                const h=parseInt(e.time.split(':')[0]); hours[h]=(hours[h]||0)+1;
            }
        });
        let max=0, peak='-';
        for(let [h,c] of Object.entries(hours)) { if(c>max){max=c; peak=`${h}-${parseInt(h)+1} Uhr`;} }
        document.getElementById('stat-early').textContent=early; document.getElementById('stat-late').textContent=late; document.getElementById('stat-peak').textContent=peak;
    }

    function initChart() {
        const ctx = document.getElementById('frequencyChart'); if(!ctx) return;
        myChart = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'LKW', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: {beginAtZero:true, ticks:{stepSize:1}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} } });
    }
    function updateChart() {
        if(!myChart) return;
        const hours=[], data=[]; const todayStr=new Date().toISOString().split('T')[0];
        for(let i=6; i<=22; i++) hours.push(i.toString().padStart(2,'0')+' Uhr');
        const counts={};
        lkwLog.forEach(e => { if(e.date===todayStr) { const h=parseInt(e.time.split(':')[0]); counts[h]=(counts[h]||0)+1; } });
        for(let i=6; i<=22; i++) data.push(counts[i]||0);
        myChart.data.labels = hours; myChart.data.datasets[0].data = data; myChart.update();
    }

    function getFormData(prefix) {
        return {
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '-',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value
        };
    }
    function calculateShift(timeStr) { const h=parseInt(timeStr.split(':')[0]); if(h>=6 && h<14) return "Fr√ºh"; if(h>=14 && h<22) return "Sp√§t"; return "Nacht"; }
    function calculateDuration(start, end) { const [h1, m1]=start.split(':').map(Number); const [h2, m2]=end.split(':').map(Number); let diff=(h2*60+m2)-(h1*60+m1); if(diff<0) diff+=1440; const h=Math.floor(diff/60), m=diff%60; return h>0 ? `${h} Std ${m} Min` : `${m} Min`; }
    function setNow(id) { document.getElementById(id).value = new Date().toTimeString().substring(0,5); }
</script>