<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LKW Logistik Leitstand V8.4">
    <title>LKW Logistik V8.4 (Live-Info & Firebase)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #2563eb; --bg: #f3f4f6; --card-bg: #ffffff;
            --text: #1f2937; --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --future: #6366f1; --gray: #9ca3af;
            --info: #0ea5e9; --intern: #8b5cf6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        main.container { max-width: 1800px; margin: 0 auto; }
        
        h1, h2, h3, h4 { color: #111827; }
        h1 { margin: 0; font-size: 1.8rem; }
        h2 { margin-top: 0; font-size: 1.25rem; }
        h3 { margin-top: 0; color: var(--primary); }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        
        section.card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; background-color: #f9fafb; }
        
        /* TABS */
        nav.tab-header { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; }
        .tab-btn { 
            flex: 1; padding: 12px; cursor: pointer; text-align: center; background: #f9fafb; 
            border: none; border-bottom: 3px solid transparent; font-weight: 700; color: #6b7280; font-size: 1.1em;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); background: #fff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* SCHICHTBUCH */
        .sb-tabs .tab-btn { font-size: 0.95em; padding: 8px; }
        .sb-container { display: none; }
        .sb-container.active { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; animation: fadeIn 0.3s; }
        .sb-col h4 { margin-top: 0; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        .sb-area {
            width: 100%; height: 200px; padding: 10px; border: 1px solid #d1d5db;
            border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; box-sizing: border-box;
        }
        .sb-early { border-color: #93c5fd; background-color: #eff6ff; }
        .sb-early:focus { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }
        .sb-late { border-color: #c4b5fd; background-color: #f5f3ff; }
        .sb-late:focus { outline: none; box-shadow: 0 0 0 3px rgba(124,58,237,0.2); }

        /* BUTTONS */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); width: 100%; font-size: 16px; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-info { background-color: var(--info); }
        .btn-intern { background-color: var(--intern); font-weight: bold; }
        .btn-export { background-color: #059669; margin-right: 10px;}
        .btn-info-window { background-color: #f59e0b; margin-right: 10px; color: #fff;}
        .btn-done { background-color: #4b5563; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        
        .btn-add { 
            background-color: #10b981; width: 100%; height: 30px; font-size: 18px; 
            display: flex; align-items: center; justify-content: center; border-radius: 4px; color: white; cursor: pointer; border: none;
        }
        .btn-remove-tour {
            background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca;
            width: 18px; height: 18px; border-radius: 3px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
            position: absolute; top: 2px; right: 2px;
        }

        /* SCHNELLWAHL */
        .quick-select-container { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .btn-quick {
            background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db;
            border-radius: 15px; padding: 4px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s;
        }
        .btn-quick:hover { background-color: var(--primary); color: white; border-color: var(--primary); }

        /* TABELLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; font-size: 0.9em; }
        td { font-size: 0.95em; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .in { background-color: #d1fae5; color: #065f46; }
        .out { background-color: #fef3c7; color: #92400e; }
        .intern { background-color: #f3e8ff; color: #6b21a8; }
        .row-overdue { background-color: #fee2e2; border-left: 5px solid var(--danger); }
        .row-finished { background-color: #f9fafb; color: #9ca3af; }
        .row-finished strong { color: #6b7280; }

        .table-input { width: 100%; min-width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; background: #fff; transition: border 0.2s; }
        .table-input:focus { border-color: var(--primary); outline: none; background: #f0f9ff; }
        .table-select { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; background: #fff; }
        .table-num { width: 100%; text-align: center; font-weight:bold; }

        .tour-cell { display: flex; flex-direction: column; gap: 4px; min-width: 80px; }
        .driver-select-small { font-size: 0.75em; padding: 2px; border: 1px solid #e5e7eb; border-radius: 4px; background-color: #f9fafb; color: #4b5563; }
        .extra-wrapper { display: flex; flex-wrap: wrap; gap: 5px; }
        .extra-box { position: relative; border: 1px dashed #9ca3af; padding: 4px; border-radius: 4px; background: #f3f4f6; width: 80px; display: flex; flex-direction: column; gap: 4px; }

        .rest-ok { background-color: #dcfce7; color: #166534; font-weight: bold; text-align: center; }
        .rest-open { background-color: #fee2e2; color: #991b1b; font-weight: bold; text-align: center; }

        /* STATS & CHART */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .stat-number { font-size: 24px; font-weight: bold; display: block; margin-top: 5px;}
        .chart-container { position: relative; height: 180px; width: 100%; }
        
        /* INFO WINDOW STYLES */
        #info-window {
            position: fixed; top: 80px; right: 20px; width: 300px; height: 250px;
            background: #fffbeb; border: 2px solid #f59e0b; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; z-index: 2000;
            flex-direction: column; overflow: hidden;
        }
        #info-header {
            background: #f59e0b; color: white; padding: 10px; display: flex; 
            justify-content: space-between; align-items: center; font-weight: bold;
        }
        #info-content { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        #global-info-text {
            width: 100%; height: 100%; resize: none; border: none; background: transparent; 
            font-family: inherit; font-size: 1.1em; outline: none;
        }
        #info-footer { padding: 5px 10px; font-size: 0.75em; color: #92400e; text-align: right; background: #fef3c7; }

        @media (max-width: 900px) { .dashboard-grid, .stats-row, .sb-container.active { grid-template-columns: 1fr; } }
        #loading-indicator { position: fixed; top: 10px; right: 10px; background: #fff; padding: 5px 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 12px; display: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="loading-indicator">üîÑ Synchronisiere...</div>

<div id="info-window">
    <div id="info-header">
        <span>üì¢ Live-Info / Aushang</span>
        <span style="cursor:pointer;" onclick="window.toggleInfo()">‚úñ</span>
    </div>
    <div id="info-content">
        <textarea id="global-info-text" placeholder="Wichtige Info f√ºr alle hier eintippen..." oninput="window.saveGlobalInfo()"></textarea>
    </div>
    <div id="info-footer">Wird automatisch synchronisiert</div>
</div>

<main class="container">
    
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1>üöõ Logistik Leitstand <span style="font-size:0.5em; color:var(--primary); vertical-align: middle;">CLOUD V8.4</span></h1>
        <div>
            <button onclick="window.toggleInfo()" class="btn btn-info-window btn-small">üì¢ Live-Info</button>
            <button onclick="window.exportToCSV()" class="btn btn-export btn-small">üíæ Excel Export</button>
        </div>
    </header>

    <section class="stats-row" aria-label="Statistiken">
        <article class="stat-box" style="border-left-color: #2563eb;">
            <span class="stat-label">Fr√ºhschicht</span><span class="stat-number" id="stat-early">0</span>
        </article>
        <article class="stat-box" style="border-left-color: #7c3aed;">
            <span class="stat-label">Sp√§tschicht</span><span class="stat-number" id="stat-late">0</span>
        </article>
        <article class="stat-box" style="border-left-color: #db2777;">
            <span class="stat-label">Sto√üzeit</span><span class="stat-number" id="stat-peak">-</span>
        </article>
    </section>

    <section class="card full-width">
        <h2>üìà Auslastung (Heute)</h2>
        <div class="chart-container"><canvas id="frequencyChart"></canvas></div>
    </section>

    <div class="dashboard-grid">
        <section class="card">
            <nav class="tab-header">
                <button class="tab-btn active" onclick="window.switchTab(this, 'tab-input-sofort')">‚ö° Sofort</button>
                <button class="tab-btn" onclick="window.switchTab(this, 'tab-input-plan')">üìÖ Neu Planen</button>
            </nav>

            <div id="tab-input-sofort" class="tab-content active">
                <form id="logForm">
                    <div class="form-group"><label>Uhrzeit</label><input type="time" id="logTime" required></div>
                    
                    <div class="form-group">
                        <label>Spedition</label>
                        <div class="quick-select-container">
                            <button type="button" class="btn btn-quick" onclick="window.fillInput('logSpedition', 'Delta Trans')">Delta Trans</button>
                            <button type="button" class="btn btn-quick" onclick="window.fillInput('logSpedition', 'Kampe')">Kampe</button>
                            <button type="button" class="btn btn-quick" onclick="window.fillInput('logSpedition', 'Rudolph')">Rudolph</button>
                            <button type="button" class="btn btn-quick" onclick="window.fillInput('logSpedition', 'PraPol')">PraPol</button>
                            <button type="button" class="btn btn-quick" onclick="window.fillInput('logSpedition', 'Mikus')">Mikus</button>
                        </div>
                        <input type="text" id="logSpedition" placeholder="z.B. Rudolph etc. (oder oben w√§hlen)" required>
                    </div>

                    <div class="form-group"><label>Kennzeichen</label><input type="text" id="logPlate" placeholder="K-AB 123"></div>
                    <div class="form-group"><label>Ware</label><input type="text" id="logWare" placeholder="Leergut etc..." required></div>
                    <div class="form-group"><label>Vorgang</label>
                        <select id="logType"><option value="Anlieferung">Anlieferung</option><option value="Abholung">Abholung</option></select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Erfassen</button>
                </form>
            </div>

            <div id="tab-input-plan" class="tab-content">
                <form id="planForm">
                    <div class="form-group"><label>Datum</label><input type="date" id="planDate" required></div>
                    
                    <div class="form-group">
                        <label>Geplante Uhrzeit (15-Min Takt)</label>
                        <div style="display:flex; gap:10px;">
                            <select id="planHour" style="width:50%" onchange="window.updatePlanTime()"></select>
                            <select id="planMinute" style="width:50%" onchange="window.updatePlanTime()">
                                <option value="00">00</option><option value="15">15</option>
                                <option value="30">30</option><option value="45">45</option>
                            </select>
                        </div>
                        <input type="hidden" id="planTime">
                    </div>

                    <div class="form-group"><label>Spedition</label><input type="text" id="planSpedition" required></div>
                    <div class="form-group"><label>Kennzeichen</label><input type="text" id="planPlate" placeholder="Kann sp√§ter eingetragen werden"></div>
                    <div class="form-group"><label>Ware</label><input type="text" id="planWare" required></div>
                    <div class="form-group"><label>Vorgang</label>
                        <select id="planType"><option value="Anlieferung">Anlieferung</option><option value="Abholung">Abholung</option></select>
                    </div>
                    <button type="submit" class="btn btn-success" style="width:100%">Einplanen</button>
                </form>
            </div>
        </section>

        <section class="card">
            <nav class="tab-header">
                <button class="tab-btn active" onclick="window.switchTab(this, 'tab-view-historie')">Heute (Ist)</button>
                <button class="tab-btn" onclick="window.switchTab(this, 'tab-view-geplant')">Heute (Plan)</button>
            </nav>

            <div id="tab-view-historie" class="tab-content active">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button onclick="window.addInternalLog()" class="btn btn-intern">üöõ Interner Transport +1</button>
                </div>
                <input type="text" id="searchInput" class="search-box" placeholder="üîç Suche nach Spedition, Kennzeichen oder Ware..." onkeyup="window.renderLogTable()">
                <div style="overflow-x:auto;">
                    <table id="logTable">
                        <thead>
                            <tr>
                                <th>Zeit</th><th>Typ</th><th>Spedition</th><th>Kennz.</th><th>Ware (Edit)</th><th>Aktion</th><th>X</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-view-geplant" class="tab-content">
                <p style="text-align:center; color:#6b7280; font-size:0.9em; margin-bottom:10px;">LKW die f√ºr heute angemeldet sind:</p>
                <div style="overflow-x:auto;">
                    <table id="planTableToday"><thead><tr><th>Zeit</th><th>Status</th><th>Vorgang</th><th>Spedition</th><th>Kennz. (Edit)</th><th>Ware</th><th>Aktion</th></tr></thead><tbody></tbody></table>
                </div>
                <p id="noTodayMsg" style="text-align:center; color:#999; display:none;">Nichts geplant.</p>
            </div>
        </section>
    </div>

    <section class="card full-width" style="border-top: 5px solid #0ea5e9;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <h3>üöõ Eigene Regeltransporte (T√§glich)</h3>
                <span style="font-size:0.9em; color:grey;">Touren 1-3 sind fest. Zusatz-Touren erscheinen, wenn 1-3 voll sind.</span>
            </div>
            <button onclick="window.loadStandardRoutes()" class="btn btn-primary" style="background-color: #0ea5e9;">üìã Standard-Liste laden</button>
        </div>

        <form id="regularForm" style="background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div style="flex-grow:1;">
                <label>Tour manuell hinzuf√ºgen</label>
                <div class="quick-select-container">
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT Q7 FBA Links VW-Hujer', 1232)">Q7 Li (VW-Hujer)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT Q7 FBA Rechts VW-Hujer', 1232)">Q7 Re (VW-Hujer)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT Q7 FBA Links Hujer-HH', 900)">Q7 Li (Hujer-HH)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT Q7 FBA Rechts Hujer-HH', 900)">Q7 Re (Hujer-HH)</button>
                    <div style="flex-basis: 100%; height: 5px;"></div> 
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT T7 FBA Links VW-Hujer', 576)">T7 Li (VW-Hujer)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT T7 FBA Rechts VW-Hujer', 512)">T7 Re (VW-Hujer)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT T7 FBA Links Hujer-HH', 420)">T7 Li (Hujer-HH)</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT T7 FBA Rechts Hujer-HH', 420)">T7 Re (Hujer-HH)</button>
                    <div style="flex-basis: 100%; height: 5px;"></div>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT MEB (Gr√ºner) VW - M32', 896)">RT MEB</button>
                    <button type="button" class="btn btn-quick" onclick="window.fillRegular('RT PPE VW - HH', 1260)">RT PPE</button>
                </div>
                <input type="text" id="regName" placeholder="z.B. RT Q7 FBA Links..." required>
            </div>
            
            <div style="width:100px;">
                <label>Soll</label>
                <input type="number" id="regTarget" placeholder="Menge" required>
            </div>
            <button type="submit" class="btn btn-info">Hinzuf√ºgen</button>
        </form>

        <h4>üìÖ Heute (<span id="dateRegToday"></span>)</h4>
        <div style="overflow-x:auto;">
            <table id="regTableToday">
                <thead>
                    <tr>
                        <th style="width:25%">Tour</th>
                        <th style="width:70px">Soll</th>
                        <th style="width:120px">1. Tour</th>
                        <th style="width:120px">2. Tour</th>
                        <th style="width:120px">3. Tour</th>
                        <th>Zusatz</th>
                        <th style="width:70px">Rest</th>
                        <th style="width:40px">X</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h4 style="margin-top:30px; color:#6b7280;">‚èÆÔ∏è Vortag (<span id="dateRegYesterday"></span>)</h4>
        <div style="overflow-x:auto; opacity: 0.8;">
            <table id="regTableYesterday">
                <thead>
                    <tr>
                        <th style="width:25%">Tour</th>
                        <th style="width:70px">Soll</th>
                        <th>1. Tour</th>
                        <th>2. Tour</th>
                        <th>3. Tour</th>
                        <th>Zusatz</th>
                        <th style="width:70px">Rest</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section class="card full-width" style="background-color: #f8fafc; border-top: 5px solid #6366f1;">
        <h2 style="color: #6366f1;">üîú Geplant (Zukunft)</h2>
        <div style="overflow-x:auto;">
             <table id="planTableFuture"><thead><tr><th>Datum</th><th>Vorgang</th><th>Spedition</th><th>Kennz. (Edit)</th><th>Ware</th><th>Aktion</th></tr></thead><tbody></tbody></table>
        </div>
    </section>

    <section class="card full-width" style="border-top: 5px solid #f59e0b;">
        <h2>üìñ Schichtbuch</h2>
        <nav class="tab-header sb-tabs">
            <button class="tab-btn active" onclick="window.switchSbTab(this, 'sb-today')">üìÖ Heute (<span id="sbDate0"></span>)</button>
            <button class="tab-btn" onclick="window.switchSbTab(this, 'sb-yesterday')">‚èÆÔ∏è Gestern (<span id="sbDate1"></span>)</button>
            <button class="tab-btn" onclick="window.switchSbTab(this, 'sb-before')">‚èÆÔ∏è Vorgestern (<span id="sbDate2"></span>)</button>
        </nav>

        <div id="sb-today" class="sb-container active">
            <div class="sb-col">
                <h4 style="color:#2563eb;">‚òÄÔ∏è Fr√ºhschicht</h4>
                <textarea id="sb-early-0" class="sb-area sb-early" placeholder="Notizen Fr√ºhschicht..." oninput="window.saveShift(0, 'early')"></textarea>
            </div>
            <div class="sb-col">
                <h4 style="color:#7c3aed;">üåô Sp√§tschicht</h4>
                <textarea id="sb-late-0" class="sb-area sb-late" placeholder="Notizen Sp√§tschicht..." oninput="window.saveShift(0, 'late')"></textarea>
            </div>
        </div>

        <div id="sb-yesterday" class="sb-container">
            <div class="sb-col">
                <h4 style="color:#2563eb;">‚òÄÔ∏è Fr√ºhschicht</h4>
                <textarea id="sb-early-1" class="sb-area sb-early" oninput="window.saveShift(1, 'early')"></textarea>
            </div>
            <div class="sb-col">
                <h4 style="color:#7c3aed;">üåô Sp√§tschicht</h4>
                <textarea id="sb-late-1" class="sb-area sb-late" oninput="window.saveShift(1, 'late')"></textarea>
            </div>
        </div>

        <div id="sb-before" class="sb-container">
            <div class="sb-col">
                <h4 style="color:#2563eb;">‚òÄÔ∏è Fr√ºhschicht</h4>
                <textarea id="sb-early-2" class="sb-area sb-early" oninput="window.saveShift(2, 'early')"></textarea>
            </div>
            <div class="sb-col">
                <h4 style="color:#7c3aed;">üåô Sp√§tschicht</h4>
                <textarea id="sb-late-2" class="sb-area sb-late" oninput="window.saveShift(2, 'late')"></textarea>
            </div>
        </div>
    </section>

</main>

<script type="module">
    // --- 1. FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, where, deleteField, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 2. FIREBASE KONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDJBsp7utlNUw4wgHsQOyznV7ioaqY76OQ",
        authDomain: "lkw-trackerneu.firebaseapp.com",
        databaseURL: "https://lkw-trackerneu-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lkw-trackerneu",
        storageBucket: "lkw-trackerneu.firebasestorage.app",
        messagingSenderId: "335563014230",
        appId: "1:335563014230:web:284080c578f89595993bf7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Globale Variablen
    let localLog = [];
    let localPlan = [];
    let localRegular = [];
    let myChart = null;
    let shiftDates = []; 

    // --- 3. HELPER FUNCTION F√úR TABS & INFO ---
    window.switchTab = (btn, targetId) => {
        const card = btn.closest('section'); 
        const parent = card || btn.closest('.card');
        parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    };

    window.switchSbTab = (btn, targetId) => {
        const header = btn.parentNode;
        header.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.sb-container').forEach(c => c.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    }

    window.toggleInfo = () => {
        const win = document.getElementById('info-window');
        win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
    };

    window.fillInput = (fieldId, value) => {
        document.getElementById(fieldId).value = value;
        if(fieldId === 'logSpedition') {
            document.getElementById('logPlate').focus();
        }
    };

    window.fillRegular = (name, target) => {
        document.getElementById('regName').value = name;
        document.getElementById('regTarget').value = target;
    };

    // --- 4. INIT & LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const beforeYesterday = new Date(today); beforeYesterday.setDate(beforeYesterday.getDate() - 2);
        const beforeYesterdayStr = beforeYesterday.toISOString().split('T')[0];

        shiftDates = [todayStr, yesterdayStr, beforeYesterdayStr];

        document.getElementById('planDate').value = todayStr;
        document.getElementById('dateRegToday').textContent = today.toLocaleDateString('de-DE');
        document.getElementById('dateRegYesterday').textContent = yesterday.toLocaleDateString('de-DE');
        
        document.getElementById('sbDate0').textContent = today.toLocaleDateString('de-DE').slice(0,5);
        document.getElementById('sbDate1').textContent = yesterday.toLocaleDateString('de-DE').slice(0,5);
        document.getElementById('sbDate2').textContent = beforeYesterday.toLocaleDateString('de-DE').slice(0,5);

        initTimeSelects();
        initChart();
        setNow('logTime');

        // LISTENERS
        const qLog = collection(db, "logs");
        onSnapshot(qLog, (snapshot) => {
            showLoading();
            localLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
            hideLoading();
        });

        const qPlan = collection(db, "plans");
        onSnapshot(qPlan, (snapshot) => {
            showLoading();
            localPlan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
            hideLoading();
        });

        const qReg = collection(db, "regular");
        onSnapshot(qReg, (snapshot) => {
            localRegular = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRegularTables(todayStr, yesterdayStr);
        });

        // SCHICHTBUCH LISTENERS
        shiftDates.forEach((dateStr, index) => {
            onSnapshot(doc(db, "shiftNotes", dateStr), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const elEarly = document.getElementById(`sb-early-${index}`);
                    const elLate = document.getElementById(`sb-late-${index}`);
                    
                    if(document.activeElement !== elEarly) elEarly.value = data.early || "";
                    if(document.activeElement !== elLate) elLate.value = data.late || "";
                }
            });
        });

        // GLOBAL INFO LISTENER
        onSnapshot(doc(db, "shiftNotes", "global"), (docSnap) => {
            if (docSnap.exists()) {
                const el = document.getElementById('global-info-text');
                if(document.activeElement !== el) {
                    el.value = docSnap.data().text || "";
                }
            }
        });

        setInterval(renderAll, 60000); 
    });

    // --- 5. LOGIK ---

    let globalInfoTimeout;
    window.saveGlobalInfo = () => {
        clearTimeout(globalInfoTimeout);
        globalInfoTimeout = setTimeout(async () => {
            const text = document.getElementById('global-info-text').value;
            try {
                await setDoc(doc(db, "shiftNotes", "global"), { text: text }, { merge: true });
            } catch(e) { console.error(e); }
        }, 800); 
    };

    let shiftTimeout;
    window.saveShift = (dayIndex, type) => { 
        clearTimeout(shiftTimeout);
        shiftTimeout = setTimeout(async () => {
            const dateStr = shiftDates[dayIndex];
            const elEarly = document.getElementById(`sb-early-${dayIndex}`);
            const elLate = document.getElementById(`sb-late-${dayIndex}`);
            
            try {
                await setDoc(doc(db, "shiftNotes", dateStr), { 
                    early: elEarly.value,
                    late: elLate.value
                }, { merge: true });
            } catch(e) { console.error(e); }
        }, 1000);
    };

    window.handleLogSubmit = async (e) => {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        try {
            await addDoc(collection(db, "logs"), entry);
            e.target.reset();
            setNow('logTime');
        } catch (err) { alert("Fehler: " + err.message); }
    };
    document.getElementById('logForm').addEventListener('submit', window.handleLogSubmit);

    window.handlePlanSubmit = async (e) => {
        e.preventDefault();
        const entry = getFormData('plan');
        entry.date = document.getElementById('planDate').value; 
        try {
            await addDoc(collection(db, "plans"), entry);
            e.target.reset();
            document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('planHour').value = "08";
            document.getElementById('planMinute').value = "00";
            window.updatePlanTime();
        } catch (err) { alert("Fehler: " + err.message); }
    };
    document.getElementById('planForm').addEventListener('submit', window.handlePlanSubmit);

    document.getElementById('regularForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('regName').value;
        const target = parseInt(document.getElementById('regTarget').value) || 0;

        try {
            await addDoc(collection(db, "regular"), {
                date: new Date().toISOString().split('T')[0],
                name: name,
                target: target,
                act1: 0, driver1: '', 
                act2: 0, driver2: '', 
                act3: 0, driver3: ''
            });
            e.target.reset();
        } catch(err) { console.error(err); }
    });

    window.addInternalLog = async () => {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0,5);
        
        const entry = {
            date: now.toISOString().split('T')[0],
            time: timeStr,
            shift: calculateShift(timeStr),
            type: 'Intern',
            spedition: 'Eigener Fuhrpark',
            plate: 'H-LH',
            ware: '', 
            departureTime: null, duration: null
        };
        
        try {
            await addDoc(collection(db, "logs"), entry);
        } catch(e) { console.error(e); }
    };

    window.addNextTour = async (id) => {
        const item = localRegular.find(r => r.id === id);
        if(!item) return;
        
        let nextIndex = 1;
        for(let i=1; i<20; i++) {
            if(item['act'+i] !== undefined) nextIndex = i + 1;
        }
        if(nextIndex < 4) nextIndex = 4;

        const updateObj = {};
        updateObj['act' + nextIndex] = 0;
        updateObj['driver' + nextIndex] = '';
        
        try {
            await updateDoc(doc(db, "regular", id), updateObj);
        } catch(e) { console.error(e); }
    };

    window.removeTour = async (id, index) => {
        if(confirm("Diese Zusatz-Tour entfernen?")) {
            try {
                const updateObj = {};
                updateObj['act' + index] = deleteField();
                updateObj['driver' + index] = deleteField();
                await updateDoc(doc(db, "regular", id), updateObj);
            } catch(e) { console.error(e); }
        }
    };

    window.loadStandardRoutes = async () => {
        const todayStr = new Date().toISOString().split('T')[0];
        const standardList = [
            { name: 'RT Q7 FBA Links VW-Hujer', target: 1232 },
            { name: 'RT Q7 FBA Rechts VW-Hujer', target: 1232 },
            { name: 'RT MEB (Gr√ºner) VW - M32', target: 896 },
            { name: 'RT PPE VW - HH', target: 1260 },
            { name: 'RT Q7 FBA Links Hujer-HH', target: 900 },
            { name: 'RT Q7 FBA Rechts Hujer-HH', target: 900 },
            { name: 'RT T7 FBA Links VW-Hujer', target: 576 },
            { name: 'RT T7 FBA Rechts VW-Hujer', target: 512 },
            { name: 'RT T7 FBA Links Hujer-HH', target: 420 },
            { name: 'RT T7 FBA Rechts Hujer-HH', target: 420 }
        ];

        let addedCount = 0;
        for (const item of standardList) {
            const exists = localRegular.some(r => r.date === todayStr && r.name === item.name);
            if (!exists) {
                try {
                    await addDoc(collection(db, "regular"), {
                        date: todayStr,
                        name: item.name,
                        target: item.target,
                        act1: 0, driver1: '', 
                        act2: 0, driver2: '', 
                        act3: 0, driver3: ''
                    });
                    addedCount++;
                } catch(e) { console.error(e); }
            }
        }
        if(addedCount > 0) alert(`${addedCount} Standard-Touren angelegt!`);
        else alert("Touren f√ºr heute waren bereits vollst√§ndig.");
    };

    window.updatePlanPlate = async (id, newPlate) => {
        try { if(id) await updateDoc(doc(db, "plans", id), { plate: newPlate }); } 
        catch (err) { console.error(err); }
    };

    window.updateLogWare = async (id, newWare) => {
        try { if(id) await updateDoc(doc(db, "logs", id), { ware: newWare }); }
        catch (err) { console.error("Fehler Update Ware:", err); }
    };

    window.updateRegular = async (id, field, value) => {
        try {
            const updateObj = {};
            if(field.startsWith('driver')) updateObj[field] = value;
            else updateObj[field] = parseInt(value) || 0;
            
            await updateDoc(doc(db, "regular", id), updateObj);
        } catch(err) { console.error(err); }
    };

    window.handleRegEnter = (e, rowId, index) => {
        if(e.key === 'Enter') {
            document.getElementById(`driver_${rowId}_${index}`).focus();
        }
    };

    window.getDriverSelect = (id, fieldName, currentValue, index) => {
        const drivers = ['S√ºss', 'Soldan', 'Mohammad', 'Demirci', 'Erol', 'Siebert', 'M√∂rs', 'Kellner'];
        let opts = `<option value="">-</option>`;
        drivers.forEach(d => {
            const sel = (currentValue === d) ? 'selected' : '';
            opts += `<option value="${d}" ${sel}>${d}</option>`;
        });
        return `<select id="driver_${id}_${index}" class="driver-select-small" onchange="window.updateRegular('${id}', '${fieldName}', this.value)">${opts}</select>`;
    };

    window.deleteLog = async (id) => {
        if(confirm("Eintrag l√∂schen?")) await deleteDoc(doc(db, "logs", id));
    };

    window.deletePlan = async (id) => {
        if(confirm("Planung l√∂schen?")) await deleteDoc(doc(db, "plans", id));
    };

    window.deleteRegular = async (id) => {
        if(confirm("Diesen Regeltransport l√∂schen?")) await deleteDoc(doc(db, "regular", id));
    };

    window.setDeparture = async (id) => {
        const item = localLog.find(x => x.id === id);
        if(!item) return;
        const nowTime = new Date().toTimeString().substring(0,5);
        const duration = calculateDuration(item.time, nowTime);

        await updateDoc(doc(db, "logs", id), {
            departureTime: nowTime,
            duration: duration
        });
    };

    window.createReturn = async (id) => {
        const original = localLog.find(x => x.id === id);
        if(!original) return;

        const newType = original.type === 'Anlieferung' ? 'Abholung' : 'Anlieferung';
        const now = new Date();
        const curTime = now.toTimeString().substring(0,5);

        const newEntry = {
            spedition: original.spedition,
            plate: original.plate,
            ware: '', 
            type: newType,
            date: now.toISOString().split('T')[0],
            time: curTime,
            shift: calculateShift(curTime),
            departureTime: null, duration: null
        };

        await addDoc(collection(db, "logs"), newEntry);
    };

    window.checkIn = async (id) => {
        const planItem = localPlan.find(x => x.id === id);
        if (!planItem) return;

        const now = new Date();
        const logEntry = {
            spedition: planItem.spedition,
            plate: planItem.plate || '?', 
            ware: planItem.ware,
            type: planItem.type,
            date: now.toISOString().split('T')[0],
            time: now.toTimeString().substring(0,5),
            shift: calculateShift(now.toTimeString().substring(0,5)),
            departureTime: null, duration: null, fromPlanId: id
        };

        await addDoc(collection(db, "logs"), logEntry);
        await deleteDoc(doc(db, "plans", id));
    };


    // --- 6. RENDER FUNKTIONEN ---
    
    window.renderAll = () => {
        window.renderLogTable();
        renderPlanTables();
        calculateStats();
        updateChart();
    };

    function renderRegularTables(todayStr, yesterdayStr) {
        const tbodyToday = document.querySelector('#regTableToday tbody');
        const tbodyYesterday = document.querySelector('#regTableYesterday tbody');
        tbodyToday.innerHTML = ''; tbodyYesterday.innerHTML = '';

        const sorted = [...localRegular].sort((a,b) => a.name.localeCompare(b.name));

        sorted.forEach(item => {
            let sum = 0;
            let maxIndex = 3; 
            for(const key in item) {
                if(key.startsWith('act')) {
                    sum += (item[key] || 0);
                    const idx = parseInt(key.replace('act', ''));
                    if(idx > maxIndex) maxIndex = idx;
                }
            }
            const rest = (item.target || 0) - sum;
            const restClass = rest <= 0 ? 'rest-ok' : 'rest-open';

            if(item.date === todayStr) {
                let fixedCols = '';
                for(let i=1; i<=3; i++) {
                    fixedCols += `
                        <td>
                            <div class="tour-cell">
                                <input type="number" class="table-input table-num" value="${item['act'+i]||''}" 
                                    onchange="window.updateRegular('${item.id}', 'act${i}', this.value)" 
                                    onkeyup="window.handleRegEnter(event, '${item.id}', ${i})">
                                ${window.getDriverSelect(item.id, 'driver'+i, item['driver'+i], i)}
                            </div>
                        </td>`;
                }

                let extrasHtml = '<div class="extra-wrapper">';
                for(let i=4; i<=maxIndex; i++) {
                    if(item['act'+i] !== undefined) {
                        extrasHtml += `
                            <div class="extra-box">
                                <input type="number" class="table-input table-num" value="${item['act'+i]||''}" 
                                    onchange="window.updateRegular('${item.id}', 'act${i}', this.value)" 
                                    onkeyup="window.handleRegEnter(event, '${item.id}', ${i})">
                                ${window.getDriverSelect(item.id, 'driver'+i, item['driver'+i], i)}
                                <div onclick="window.removeTour('${item.id}', ${i})" class="btn-remove-tour" title="Entfernen">√ó</div>
                            </div>
                        `;
                    }
                }
                
                const basicFull = (item.act1 > 0 && item.act2 > 0 && item.act3 > 0);
                if(basicFull) {
                    extrasHtml += `<button onclick="window.addNextTour('${item.id}')" class="btn btn-add" title="Zusatz-Tour">+</button>`;
                }
                extrasHtml += '</div>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${item.name}</strong></td>
                    <td>${item.target}</td>
                    ${fixedCols}
                    <td>${extrasHtml}</td>
                    <td class="${restClass}">${rest}</td>
                    <td><button onclick="window.deleteRegular('${item.id}')" class="btn btn-danger btn-small">X</button></td>
                `;
                tbodyToday.appendChild(tr);

            } else if (item.date === yesterdayStr) {
                let t1 = `${item.act1||0} (${item.driver1||'-'})`;
                let t2 = `${item.act2||0} (${item.driver2||'-'})`;
                let t3 = `${item.act3||0} (${item.driver3||'-'})`;
                let extras = [];
                for(let i=4; i<=maxIndex; i++) {
                    if(item['act'+i]) extras.push(`${item['act'+i]} (${item['driver'+i]||'-'})`);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.target}</td>
                    <td>${t1}</td><td>${t2}</td><td>${t3}</td>
                    <td>${extras.join(', ')}</td>
                    <td class="${restClass}">${rest}</td>
                `;
                tbodyYesterday.appendChild(tr);
            }
        });
    }

    window.renderLogTable = () => {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const searchText = document.getElementById('searchInput').value.toLowerCase(); 

        const sorted = [...localLog].sort((a, b) => {
            const aDone = !!a.departureTime;
            const bDone = !!b.departureTime;
            if (aDone !== bDone) return aDone ? 1 : -1;
            return b.time.localeCompare(a.time);
        });

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return;
            
            const searchString = `${entry.spedition} ${entry.plate} ${entry.ware} ${entry.type}`.toLowerCase();
            if(searchText && !searchString.includes(searchText)) return; 

            const badge = entry.type === 'Intern' ? 'intern' : (entry.type === 'Anlieferung' ? 'in' : 'out');
            const tr = document.createElement('tr');
            
            let statusContent = '';
            
            if (entry.departureTime) {
                tr.className = 'row-finished';
                statusContent = `‚úÖ <span style="font-size:0.9em">${entry.duration}</span>`;
            } else {
                statusContent = `
                    <button onclick="window.createReturn('${entry.id}')" class="btn btn-info btn-icon" title="Gegenlauf erzeugen">üîÑ</button>
                    <button onclick="window.setDeparture('${entry.id}')" class="btn btn-done btn-icon" title="Fertig">‚úÖ</button>
                `;
            }

            const wareInput = `<input type="text" class="table-input" value="${entry.ware||''}" placeholder="..." onchange="window.updateLogWare('${entry.id}', this.value)">`;

            tr.innerHTML = `
                <td><strong>${entry.time}</strong></td>
                <td><span class="badge ${badge}">${entry.type}</span></td>
                <td>${entry.spedition}</td>
                <td>${entry.plate}</td>
                <td>${wareInput}</td>
                <td>${statusContent}</td>
                <td><button onclick="window.deleteLog('${entry.id}')" class="btn btn-danger btn-small">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    };

    function renderPlanTables() {
        const tbodyToday = document.querySelector('#planTableToday tbody');
        const tbodyFuture = document.querySelector('#planTableFuture tbody');
        tbodyToday.innerHTML = ''; tbodyFuture.innerHTML = '';
        
        const todayStr = new Date().toISOString().split('T')[0];
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        
        const sorted = [...localPlan].sort((a,b) => (a.date === b.date) ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date));

        let cT=0;
        sorted.forEach(e => {
            const badge = e.type === 'Anlieferung' ? 'in' : 'out';
            const plateInput = `<input type="text" class="table-input" value="${e.plate || ''}" placeholder="?" onchange="window.updatePlanPlate('${e.id}', this.value)">`;
            
            if(e.date === todayStr) {
                cT++;
                const [h, m] = e.time.split(':').map(Number);
                const isLate = curMin > (h*60+m);
                const tr = document.createElement('tr');
                tr.className = isLate ? 'row-overdue' : '';
                
                const btn = `<button onclick="window.checkIn('${e.id}')" class="btn btn-success btn-small">Ist da</button> <button onclick="window.deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button>`;
                
                tr.innerHTML = `
                    <td><strong>${e.time}</strong></td>
                    <td>${isLate?'‚ö†Ô∏è':'Geplant'}</td>
                    <td><span class="badge ${badge}">${e.type}</span></td>
                    <td>${e.spedition}</td>
                    <td>${plateInput}</td>
                    <td>${e.ware || '-'}</td> 
                    <td>${btn}</td>`;
                tbodyToday.appendChild(tr);
            } else if (e.date > todayStr) {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${new Date(e.date).toLocaleDateString()}</td>
                    <td><span class="badge ${badge}">${e.type}</span></td>
                    <td>${e.spedition}</td>
                    <td>${plateInput}</td>
                    <td>${e.ware || '-'}</td>
                    <td><button onclick="window.deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button></td>`;
                tbodyFuture.appendChild(tr);
            }
        });
        document.getElementById('noTodayMsg').style.display = cT===0?'block':'none';
    }

    // --- 7. HELPER UTILS ---
    function getFormData(prefix) {
        return {
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value
        };
    }
    function calculateShift(timeStr) {
        const h = parseInt(timeStr.split(':')[0]);
        if(h>=6 && h<14) return "Fr√ºh"; if(h>=14 && h<22) return "Sp√§t"; return "Nacht";
    }
    function calculateDuration(start, end) {
        const [h1, m1] = start.split(':').map(Number);
        const [h2, m2] = end.split(':').map(Number);
        let diff = (h2*60+m2) - (h1*60+m1);
        if(diff<0) diff+=1440;
        const h=Math.floor(diff/60), m=diff%60;
        return h>0 ? `${h}h ${m}m` : `${m}m`;
    }
    function setNow(id) { document.getElementById(id).value = new Date().toTimeString().substring(0,5); }
    
    function initTimeSelects() {
        const hourSelect = document.getElementById('planHour');
        for(let i=0; i<24; i++) {
            const val = i.toString().padStart(2, '0');
            const opt = document.createElement('option');
            opt.value = val; opt.text = val + ' Uhr';
            if(i === 8) opt.selected = true;
            hourSelect.appendChild(opt);
        }
        window.updatePlanTime();
    }
    window.updatePlanTime = () => {
        const h = document.getElementById('planHour').value;
        const m = document.getElementById('planMinute').value;
        document.getElementById('planTime').value = `${h}:${m}`;
    }

    window.exportToCSV = () => {
        let csv = "Datum;Ankunft;Abfahrt;Dauer;Spedition;Kennzeichen;Ware;Typ\n";
        localLog.forEach(r => csv += `${r.date};${r.time};${r.departureTime||'-'};${r.duration||'-'};${r.spedition};${r.plate};${r.ware};${r.type}\n`);
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        link.download = `LKW_Export_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }

    function showLoading() { document.getElementById('loading-indicator').style.display = 'block'; }
    function hideLoading() { document.getElementById('loading-indicator').style.display = 'none'; }

    // --- 8. CHART ---
    function initChart() {
        const ctx = document.getElementById('frequencyChart');
        if(!ctx) return;
        myChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'LKW', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', borderWidth: 3, fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: {beginAtZero:true, ticks:{stepSize:1}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} }
        });
    }
    function updateChart() {
        if(!myChart) return;
        const hours=[], data=[]; const todayStr=new Date().toISOString().split('T')[0];
        for(let i=6; i<=22; i++) hours.push(i.toString().padStart(2,'0')+' Uhr');
        const counts={};
        
        localLog.forEach(e => { 
            if(e.date===todayStr) { 
                const h=parseInt(e.time.split(':')[0]); 
                counts[h]=(counts[h]||0)+1; 
            } 
        });

        for(let i=6; i<=22; i++) data.push(counts[i]||0);
        myChart.data.labels = hours; myChart.data.datasets[0].data = data; myChart.update();
    }
    function calculateStats() {
        let early=0, late=0, hours={}; const todayStr=new Date().toISOString().split('T')[0];
        localLog.forEach(e => {
            if(e.date===todayStr) {
                if(e.shift==='Fr√ºh') early++; if(e.shift==='Sp√§t') late++;
                const h=parseInt(e.time.split(':')[0]); hours[h]=(hours[h]||0)+1;
            }
        });
        let max=0, peak='-';
        for(let [h,c] of Object.entries(hours)) { if(c>max){max=c; peak=`${h}-${parseInt(h)+1} Uhr`;} }
        document.getElementById('stat-early').textContent=early; document.getElementById('stat-late').textContent=late; document.getElementById('stat-peak').textContent=peak;
    }
</script>
</body>
</html>