<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKW Logistik Leitstand (LIVE / CLOUD)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- DESIGN (Identisch zu V4.7) --- */
        :root {
            --primary: #2563eb; --bg: #f3f4f6; --card-bg: #ffffff;
            --text: #1f2937; --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --future: #6366f1; --gray: #9ca3af;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1, h2 { color: #111827; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 0; font-size: 1.25rem; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 40px; }
        .full-width { grid-column: 1 / -1; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; background-color: #f9fafb; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); width: 100%; font-size: 16px; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-mail { background-color: var(--warning); color: black; }
        .btn-export { background-color: #059669; margin-right: 10px;}
        .btn-done { background-color: #4b5563; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .in { background-color: #d1fae5; color: #065f46; }
        .out { background-color: #fef3c7; color: #92400e; }
        .row-overdue { background-color: #fee2e2; border-left: 5px solid var(--danger); }
        .row-finished { background-color: #f9fafb; color: #9ca3af; }
        .row-finished strong { color: #6b7280; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .stat-number { font-size: 24px; font-weight: bold; display: block; margin-top: 5px;}
        .chart-container { position: relative; height: 180px; width: 100%; }
        #status-indicator { font-size: 0.9em; color: #ef4444; font-weight: bold;}

        @media (max-width: 900px) { .dashboard-grid, .stats-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üöõ Logistik Leitstand</h1>
        <div style="text-align: right;">
            <div id="status-indicator">üî¥ Offline</div>
            <div style="margin-top:5px;">
                <button onclick="exportToCSV()" class="btn btn-export btn-small">üíæ Excel Export</button>
            </div>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-box" style="border-left-color: #2563eb;">
            <span class="stat-label">Fr√ºhschicht</span><span class="stat-number" id="stat-early">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #7c3aed;">
            <span class="stat-label">Sp√§tschicht</span><span class="stat-number" id="stat-late">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #db2777;">
            <span class="stat-label">Sto√üzeit</span><span class="stat-number" id="stat-peak">-</span>
        </div>
    </div>

    <div class="card full-width">
        <h2>üìà Auslastung (Heute)</h2>
        <div class="chart-container"><canvas id="frequencyChart"></canvas></div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>‚ö° Sofort-Erfassung</h2>
            <form id="logForm">
                <div class="form-group"><label>Uhrzeit</label><input type="time" id="logTime" required></div>
                <div class="form-group"><label>Spedition</label><input type="text" id="logSpedition" placeholder="z.B. DHL" required></div>
                <div class="form-group"><label>Kennzeichen</label><input type="text" id="logPlate" placeholder="K-AB 123"></div>
                <div class="form-group"><label>Ware</label><input type="text" id="logWare" placeholder="Stahl..." required></div>
                <div class="form-group"><label>Vorgang</label>
                    <select id="logType"><option value="Anlieferung">Anlieferung</option><option value="Abholung">Abholung</option></select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Erfassen</button>
            </form>
        </div>

        <div class="card">
            <h2>‚úÖ Historie (Heute)</h2>
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Suche nach Spedition, Kennzeichen oder Ware..." onkeyup="renderLogTable()">
            
            <div style="overflow-x:auto;">
                <table id="logTable">
                    <thead><tr><th>Zeit</th><th>Typ</th><th>Spedition</th><th>Kennz.</th><th>Status/Dauer</th><th>X</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="section-title" style="margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5em;">üìÖ</span><h2>Planung</h2>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>LKW Vorplanen</h2>
            <form id="planForm">
                <div class="form-group"><label>Datum</label><input type="date" id="planDate" required></div>
                <div class="form-group">
                    <label>Geplante Uhrzeit (15-Min Takt)</label>
                    <div style="display:flex; gap:10px;">
                        <select id="planHour" style="width:50%" onchange="updatePlanTime()"></select>
                        <select id="planMinute" style="width:50%" onchange="updatePlanTime()">
                            <option value="00">00</option><option value="15">15</option>
                            <option value="30">30</option><option value="45">45</option>
                        </select>
                    </div>
                    <input type="hidden" id="planTime">
                </div>
                <div class="form-group"><label>Spedition</label><input type="text" id="planSpedition" required></div>
                <div class="form-group"><label>Kennzeichen</label><input type="text" id="planPlate"></div>
                <div class="form-group"><label>Ware</label><input type="text" id="planWare" required></div>
                <div class="form-group"><label>Vorgang</label>
                    <select id="planType"><option value="Anlieferung">Anlieferung</option><option value="Abholung">Abholung</option></select>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%">Einplanen</button>
            </form>
        </div>

        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="card">
                <h2 style="color: #2563eb;">üî• Heute (<span id="dateDisplayToday"></span>)</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableToday"><thead><tr><th>Zeit</th><th>Status</th><th>Vorgang</th><th>Spedition</th><th>Aktion</th></tr></thead><tbody></tbody></table>
                </div>
                <p id="noTodayMsg" style="text-align:center; color:#999; display:none;">Nichts geplant.</p>
            </div>
            <div class="card" style="background-color: #f8fafc;">
                <h2 style="color: #6366f1;">üîú Zukunft</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableFuture"><thead><tr><th>Datum</th><th>Vorgang</th><th>Spedition</th><th>Ware</th><th>Aktion</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE CLOUD ANBINDUNG ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ------------------------------------------------------------
    // ACHTUNG: HIER WIEDER DEINE DATEN EINF√úGEN!
    // ------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "HIER_DEIN_API_KEY",
        authDomain: "lkw-tracker.firebaseapp.com",
        databaseURL: "https://lkw-tracker-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lkw-tracker",
        storageBucket: "lkw-tracker.firebasestorage.app",
        messagingSenderId: "DEINE_ID",
        appId: "DEINE_APP_ID"
    };
    // ------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Status Update
    const statusEl = document.getElementById('status-indicator');
    statusEl.textContent = "üü¢ ONLINE (Live)";
    statusEl.style.color = "#10b981";

    let lkwLog = [];
    let lkwPlan = [];
    let myChart = null;
    const EMAIL_RECIPIENT = "alexander.kellner@haertecenter.de";

    // --- DATEN LADEN (LIVE) ---
    // Das hier passiert automatisch, wenn ein Kollege etwas √§ndert
    onValue(ref(db, 'logs'), (snapshot) => {
        lkwLog = [];
        const data = snapshot.val();
        if(data) Object.keys(data).forEach(k => lkwLog.push({ id: k, ...data[k] }));
        renderAll();
    });

    onValue(ref(db, 'plans'), (snapshot) => {
        lkwPlan = [];
        const data = snapshot.val();
        if(data) Object.keys(data).forEach(k => lkwPlan.push({ id: k, ...data[k] }));
        renderAll();
    });

    // --- INITIALISIERUNG ---
    setNow('logTime');
    initTimeSelects();
    initChart();
    document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('dateDisplayToday').textContent = new Date().toLocaleDateString('de-DE');

    // --- GLOBAL FUNCTIONS (Damit HTML Buttons funktionieren) ---
    window.addLog = (e) => {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        entry.departureTime = null; 
        entry.duration = null;
        push(ref(db, 'logs'), entry);
        document.getElementById('logForm').reset();
        setNow('logTime');
    };

    window.addPlan = (e) => {
        e.preventDefault();
        const entry = getFormData('plan');
        entry.date = document.getElementById('planDate').value;
        push(ref(db, 'plans'), entry);
        document.getElementById('planForm').reset();
        document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('planHour').value = "08";
        document.getElementById('planMinute').value = "00";
        window.updatePlanTime();
    };

    window.setDeparture = (id) => {
        const item = lkwLog.find(x => x.id === id);
        if(item) {
            const nowTime = new Date().toTimeString().substring(0,5);
            const duration = calculateDuration(item.time, nowTime);
            update(ref(db, 'logs/' + id), {
                departureTime: nowTime,
                duration: duration
            });
        }
    };

    window.checkIn = (id) => {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;
        const now = new Date();
        const timeStr = now.toTimeString().substring(0,5);
        const logEntry = {
            ...item, date: now.toISOString().split('T')[0], time: timeStr, shift: calculateShift(timeStr),
            departureTime: null, duration: null
        };
        // Atomar: Erst speichern, dann l√∂schen
        push(ref(db, 'logs'), logEntry);
        remove(ref(db, 'plans/' + id));
    };

    window.deleteLog = (id) => { if(confirm("L√∂schen?")) remove(ref(db, 'logs/' + id)); };
    window.deletePlan = (id) => { if(confirm("L√∂schen?")) remove(ref(db, 'plans/' + id)); };
    window.sendLateMail = (id) => { location.href = `mailto:${EMAIL_RECIPIENT}?subject=Verzug&body=LKW √ºberf√§llig`; };
    
    // --- HELPER ---
    window.updatePlanTime = () => {
        const h = document.getElementById('planHour').value;
        const m = document.getElementById('planMinute').value;
        document.getElementById('planTime').value = `${h}:${m}`;
    };

    window.renderLogTable = () => { renderLogTableInternal(); };
    window.exportToCSV = () => {
        let csv = "Datum;Ankunft;Abfahrt;Dauer;Spedition;Kennzeichen;Ware;Typ\n";
        lkwLog.forEach(r => csv += `${r.date};${r.time};${r.departureTime||'-'};${r.duration||'-'};${r.spedition};${r.plate};${r.ware};${r.type}\n`);
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        link.download = `LKW_Export_${new Date().toLocaleDateString()}.csv`;
        link.click();
    };

    // --- INTERNALS ---
    document.getElementById('logForm').addEventListener('submit', window.addLog);
    document.getElementById('planForm').addEventListener('submit', window.addPlan);

    function initTimeSelects() {
        const hourSelect = document.getElementById('planHour');
        for(let i=0; i<24; i++) {
            const val = i.toString().padStart(2,'0');
            const opt = document.createElement('option'); opt.value=val; opt.text=val+' Uhr';
            if(i===8) opt.selected=true;
            hourSelect.appendChild(opt);
        }
        window.updatePlanTime();
    }

    function renderAll() { renderLogTableInternal(); renderPlanTables(); calculateStats(); updateChart(); }

    function renderLogTableInternal() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        
        const sorted = [...lkwLog].sort((a,b) => b.time.localeCompare(a.time));

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return;
            const searchString = `${entry.spedition} ${entry.plate} ${entry.ware} ${entry.type}`.toLowerCase();
            if(searchText && !searchString.includes(searchText)) return;

            const badge = entry.type === 'Anlieferung' ? 'in' : 'out';
            const tr = document.createElement('tr');
            
            let statusContent = '';
            if (entry.departureTime) {
                tr.className = 'row-finished';
                statusContent = `‚úÖ <strong>${entry.duration}</strong> <br><span style="font-size:0.8em">Ab: ${entry.departureTime}</span>`;
            } else {
                statusContent = `<button onclick="setDeparture('${entry.id}')" class="btn btn-done btn-small">Abfertigen ‚è±Ô∏è</button>`;
            }

            tr.innerHTML = `<td><strong>${entry.time}</strong></td><td><span class="badge ${badge}">${entry.type}</span></td><td>${entry.spedition}</td><td>${entry.plate}</td><td>${statusContent}</td><td><button onclick="deleteLog('${entry.id}')" class="btn btn-danger btn-small">X</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderPlanTables() {
        const tbodyToday = document.querySelector('#planTableToday tbody');
        const tbodyFuture = document.querySelector('#planTableFuture tbody');
        tbodyToday.innerHTML = ''; tbodyFuture.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        const sorted = [...lkwPlan].sort((a,b) => (a.date === b.date) ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date));

        let cT=0;
        sorted.forEach(e => {
            const badge = e.type === 'Anlieferung' ? 'in' : 'out';
            if(e.date === todayStr) {
                cT++;
                const [h, m] = e.time.split(':').map(Number);
                const isLate = curMin > (h*60+m);
                const tr = document.createElement('tr');
                tr.className = isLate ? 'row-overdue' : 'row-planned';
                let btn = isLate 
                    ? `<button onclick="checkIn('${e.id}')" class="btn btn-success btn-small">Ist da</button>`
                    : `<button onclick="checkIn('${e.id})" class="btn btn-success btn-small">Ist da</button> <button onclick="deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button>`;
                tr.innerHTML = `<td><strong>${e.time}</strong></td><td>${isLate?'‚ö†Ô∏è':'Geplant'}</td><td><span class="badge ${badge}">${e.type}</span></td><td>${e.spedition}</td><td>${btn}</td>`;
                tbodyToday.appendChild(tr);
            } else if (e.date > todayStr) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${new Date(e.date).toLocaleDateString()}</td><td><span class="badge ${badge}">${e.type}</span></td><td>${e.spedition}</td><td>${e.ware}</td><td><button onclick="deletePlan('${e.id}')" class="btn btn-danger btn-small">X</button></td>`;
                tbodyFuture.appendChild(tr);
            }
        });
        document.getElementById('noTodayMsg').style.display = cT===0?'block':'none';
    }

    function calculateStats() {
        let early=0, late=0, hours={}; const todayStr=new Date().toISOString().split('T')[0];
        lkwLog.forEach(e => {
            if(e.date===todayStr) {
                if(e.shift==='Fr√ºh') early++; if(e.shift==='Sp√§t') late++;
                const h=parseInt(e.time.split(':')[0]); hours[h]=(hours[h]||0)+1;
            }
        });
        let max=0, peak='-';
        for(let [h,c] of Object.entries(hours)) { if(c>max){max=c; peak=`${h}-${parseInt(h)+1} Uhr`;} }
        document.getElementById('stat-early').textContent=early; document.getElementById('stat-late').textContent=late; document.getElementById('stat-peak').textContent=peak;
    }

    function initChart() {
        const ctx = document.getElementById('frequencyChart'); if(!ctx) return;
        myChart = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'LKW', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: {beginAtZero:true, ticks:{stepSize:1}}, x:{grid:{display:false}}}, plugins:{legend:{display:false}} } });
    }
    function updateChart() {
        if(!myChart) return;
        const hours=[], data=[]; const todayStr=new Date().toISOString().split('T')[0];
        for(let i=6; i<=22; i++) hours.push(i.toString().padStart(2,'0')+' Uhr');
        const counts={};
        lkwLog.forEach(e => { if(e.date===todayStr) { const h=parseInt(e.time.split(':')[0]); counts[h]=(counts[h]||0)+1; } });
        for(let i=6; i<=22; i++) data.push(counts[i]||0);
        myChart.data.labels = hours; myChart.data.datasets[0].data = data; myChart.update();
    }

    function getFormData(prefix) {
        return {
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '-',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value
        };
    }
    function calculateShift(timeStr) { const h=parseInt(timeStr.split(':')[0]); if(h>=6 && h<14) return "Fr√ºh"; if(h>=14 && h<22) return "Sp√§t"; return "Nacht"; }
    function calculateDuration(start, end) { const [h1, m1]=start.split(':').map(Number); const [h2, m2]=end.split(':').map(Number); let diff=(h2*60+m2)-(h1*60+m1); if(diff<0) diff+=1440; const h=Math.floor(diff/60), m=diff%60; return h>0 ? `${h} Std ${m} Min` : `${m} Min`; }
    function setNow(id) { document.getElementById(id).value = new Date().toTimeString().substring(0,5); }
</script>
</body>
</html>