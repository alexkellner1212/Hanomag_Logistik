<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKW Logistik LEITSTAND (Live)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb; --bg: #f3f4f6; --card-bg: #ffffff;
            --text: #1f2937; --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --future: #6366f1;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1, h2 { color: #111827; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 0; font-size: 1.25rem; }
        
        /* Layout */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 40px; }
        .full-width { grid-column: 1 / -1; }
        
        /* Karten & Formulare */
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; width: 100%; }
        .btn-primary { background-color: var(--primary); font-size: 16px; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); width: auto; padding: 4px 8px; font-size: 12px;}
        .btn-mail { background-color: var(--warning); color: black; width: auto; padding: 4px 8px; font-size: 12px; }
        .btn-small { width: auto; padding: 5px 10px; }

        /* Tabellen */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .in { background-color: #d1fae5; color: #065f46; }
        .out { background-color: #fef3c7; color: #92400e; }
        
        /* Status Farben */
        .row-overdue { background-color: #fee2e2; border-left: 5px solid var(--danger); }
        .row-planned { border-left: 5px solid var(--primary); }
        .row-future { border-left: 5px solid var(--future); color: #555; }

        /* Stats & Chart */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .stat-number { font-size: 24px; font-weight: bold; display: block; margin-top: 5px;}
        .chart-container { position: relative; height: 180px; width: 100%; }
        
        /* Loading Status */
        #status-indicator { text-align: right; font-size: 0.8em; color: #999; margin-bottom: 10px; }

        @media (max-width: 900px) { .dashboard-grid, .stats-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>ðŸš› Logistik Leitstand Hanomag </h1>
        <div id="status-indicator">ðŸ”´ Offline (Verbinde...)</div>
    </div>

    <div class="stats-row">
        <div class="stat-box" style="border-left-color: #2563eb;">
            <span class="stat-label">FrÃ¼hschicht (Heute)</span>
            <span class="stat-number" id="stat-early">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #7c3aed;">
            <span class="stat-label">SpÃ¤tschicht (Heute)</span>
            <span class="stat-number" id="stat-late">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #db2777;">
            <span class="stat-label">StoÃŸzeit</span>
            <span class="stat-number" id="stat-peak">-</span>
        </div>
    </div>

    <div class="card full-width">
        <h2>ðŸ“ˆ Auslastung (Live)</h2>
        <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>âš¡ Sofort-Erfassung (Heute)</h2>
            <form id="logForm">
                <input type="time" id="logTime" required>
                <input type="text" id="logSpedition" placeholder="Spedition" required>
                <input type="text" id="logPlate" placeholder="Kennzeichen">
                <input type="text" id="logWare" placeholder="Ware" required>
                <select id="logType">
                    <option value="Anlieferung">Anlieferung</option>
                    <option value="Abholung">Abholung</option>
                </select>
                <button type="submit" class="btn btn-primary">LKW Erfassen</button>
            </form>
        </div>
        <div class="card">
            <h2>âœ… Historie / Ist-Zustand (Heute)</h2>
            <div style="overflow-x:auto;">
                <table id="logTable">
                    <thead><tr><th>Zeit</th><th>Typ</th><th>Spedition</th><th>Kennz.</th><th>LÃ¶schen</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <hr style="border:0; border-top: 2px dashed #ccc; margin: 40px 0;">

    <div style="margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5em;">ðŸ“…</span><h2>Planung</h2>
    </div>
    <div class="dashboard-grid">
        <div class="card">
            <h2>Neuen LKW vorplanen</h2>
            <form id="planForm">
                <label>Datum</label>
                <input type="date" id="planDate" required>
                <label>Uhrzeit</label>
                <input type="time" id="planTime" required>
                <input type="text" id="planSpedition" placeholder="Spedition" required>
                <input type="text" id="planPlate" placeholder="Kennzeichen">
                <input type="text" id="planWare" placeholder="Ware" required>
                <select id="planType">
                    <option value="Anlieferung">Anlieferung</option>
                    <option value="Abholung">Abholung</option>
                </select>
                <button type="submit" class="btn btn-success">Einplanen</button>
            </form>
        </div>
        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="card">
                <h2 style="color:#2563eb;">ðŸ”¥ Heute (<span id="dateDisplayToday"></span>)</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableToday">
                        <thead><tr><th>Zeit</th><th>Status</th><th>Spedition</th><th>Aktion</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="noTodayMsg" style="text-align:center; color:#999; display:none;">Nichts geplant.</p>
            </div>
            <div class="card" style="background-color:#f8fafc;">
                <h2 style="color:#6366f1;">ðŸ”œ Zukunft</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableFuture">
                        <thead><tr><th>Datum</th><th>Spedition</th><th>Ware</th><th>Aktion</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE IMPORT & CONFIG ---
    // Wir nutzen hier die Web-Versionen der Module direkt vom Google Server
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // DEINE KONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyCGNKg_GrHqrms0Tf2lR0U8QwosuTH7YBI",
        authDomain: "lkw-tracker.firebaseapp.com",
        databaseURL: "https://lkw-tracker-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lkw-tracker",
        storageBucket: "lkw-tracker.firebasestorage.app",
        messagingSenderId: "589342000908",
        appId: "1:589342000908:web:1ce475e345090eb7daab29",
        measurementId: "G-5KKPWGRFNN"
    };

    // App Starten
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Verbindungstest
    document.getElementById('status-indicator').innerHTML = "ðŸŸ¢ Online & Synchronisiert";

    // --- GLOBALE VARIABLEN ---
    let lkwLog = [];
    let lkwPlan = [];
    let myChart = null;
    const EMAIL_RECIPIENT = "alexander.kellner@haertecenter.de";

    // --- DATENBANK LISTENER (LIVE UPDATES) ---
    
    // 1. Logs laden
    onValue(ref(db, 'logs'), (snapshot) => {
        lkwLog = [];
        const data = snapshot.val();
        if(data) {
            Object.keys(data).forEach(key => {
                lkwLog.push({ id: key, ...data[key] });
            });
        }
        renderAll();
    });

    // 2. PlÃ¤ne laden
    onValue(ref(db, 'plans'), (snapshot) => {
        lkwPlan = [];
        const data = snapshot.val();
        if(data) {
            Object.keys(data).forEach(key => {
                lkwPlan.push({ id: key, ...data[key] });
            });
        }
        renderAll();
    });

    // --- FUNKTIONEN (An window binden damit HTML sie findet) ---

    // Neuen Logeintrag (Sofort) speichern
    window.addLog = (e) => {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        
        push(ref(db, 'logs'), entry);
        
        document.getElementById('logForm').reset();
        setNow('logTime');
    };

    // Neue Planung speichern
    window.addPlan = (e) => {
        e.preventDefault();
        const entry = getFormData('plan');
        entry.notified = false;
        
        push(ref(db, 'plans'), entry);
        
        document.getElementById('planForm').reset();
        document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    };

    // LÃ¶schen
    window.deleteLog = (id) => { if(confirm("Eintrag unwiderruflich lÃ¶schen?")) remove(ref(db, 'logs/' + id)); };
    window.deletePlan = (id) => { if(confirm("Planung lÃ¶schen?")) remove(ref(db, 'plans/' + id)); };

    // Check-In (Von Plan zu Log)
    window.checkIn = (id) => {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;

        const now = new Date();
        const timeStr = now.toTimeString().substring(0,5);
        const dateStr = now.toISOString().split('T')[0];

        const logEntry = {
            spedition: item.spedition,
            plate: item.plate || '-',
            ware: item.ware,
            type: item.type,
            date: dateStr,
            time: timeStr,
            shift: calculateShift(timeStr)
        };

        // Parallel: In Log schreiben UND aus Plan lÃ¶schen
        push(ref(db, 'logs'), logEntry);
        remove(ref(db, 'plans/' + id));
    };

    // E-Mail senden
    window.sendLateMail = (id) => {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;
        const subject = `VERZUG: LKW ${item.spedition}`;
        const body = `Hallo Alexander,\n\nder LKW (${item.spedition}) geplant fÃ¼r ${item.date} um ${item.time} Uhr ist noch nicht erschienen.\nWare: ${item.ware}`;
        location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };

    // --- HELPER ---
    function getFormData(prefix) {
        const dateEl = document.getElementById(prefix + 'Date');
        return {
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '-',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value,
            date: dateEl ? dateEl.value : null
        };
    }

    function calculateShift(timeStr) {
        const h = parseInt(timeStr.split(':')[0]);
        if (h >= 6 && h < 14) return "FrÃ¼h";
        if (h >= 14 && h < 22) return "SpÃ¤t";
        return "Nacht";
    }

    function setNow(id) {
        document.getElementById(id).value = new Date().toTimeString().substring(0,5);
    }

    // --- UI RENDERING ---

    function renderAll() {
        renderLogTable();
        renderPlanTables();
        calculateStats();
        updateChart();
    }

    function renderLogTable() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        
        // Sortieren: Neueste zuerst
        const sorted = [...lkwLog].sort((a,b) => b.time.localeCompare(a.time));

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return; // Nur heute anzeigen
            const badgeClass = entry