<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKW Logistik CLOUD (Live-Sync)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --future: #6366f1;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1, h2 { color: #111827; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 0; font-size: 1.25rem; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 40px; }
        .full-width { grid-column: 1 / -1; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); width: 100%; font-size: 16px; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-mail { background-color: var(--warning); color: black; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .in { background-color: #d1fae5; color: #065f46; }
        .out { background-color: #fef3c7; color: #92400e; }
        .row-overdue { background-color: #fee2e2; border-left: 5px solid var(--danger); }
        .row-planned { border-left: 5px solid var(--primary); }
        .row-future { border-left: 5px solid var(--future); color: #555; }
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .stat-number { font-size: 24px; font-weight: bold; display: block; margin-top: 5px;}
        .section-title { margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-icon { font-size: 1.5em; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        /* Loader */
        #loader { text-align: center; padding: 20px; font-weight: bold; color: var(--primary); display: none;}
        
        @media (max-width: 900px) { .dashboard-grid, .stats-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üöõ Logistik Leitstand (Live Cloud)</h1>
        </div>
    
    <div id="loader">Lade Daten aus der Cloud...</div>

    <div class="stats-row">
        <div class="stat-box" style="border-left-color: #2563eb;">
            <span class="stat-label">Fr√ºhschicht (Heute)</span>
            <span class="stat-number" id="stat-early">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #7c3aed;">
            <span class="stat-label">Sp√§tschicht (Heute)</span>
            <span class="stat-number" id="stat-late">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #db2777;">
            <span class="stat-label">Sto√üzeit</span>
            <span class="stat-number" id="stat-peak">-</span>
        </div>
    </div>

    <div class="card full-width">
        <h2>üìà Auslastung (Live)</h2>
        <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>‚ö° Sofort-Erfassung (Heute)</h2>
            <form id="logForm">
                <input type="time" id="logTime" required style="margin-bottom:10px;">
                <input type="text" id="logSpedition" placeholder="Spedition" required style="margin-bottom:10px;">
                <input type="text" id="logPlate" placeholder="Kennzeichen" style="margin-bottom:10px;">
                <input type="text" id="logWare" placeholder="Ware" required style="margin-bottom:10px;">
                <select id="logType" style="margin-bottom:10px;">
                    <option value="Anlieferung">Anlieferung</option>
                    <option value="Abholung">Abholung</option>
                </select>
                <button type="submit" class="btn btn-primary">LKW Erfassen</button>
            </form>
        </div>
        <div class="card">
            <h2>‚úÖ Historie / Ist-Zustand (Heute)</h2>
            <div style="overflow-x:auto;">
                <table id="logTable">
                    <thead><tr><th>Zeit</th><th>Typ</th><th>Spedition</th><th>Kennz.</th><th>L√∂schen</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <hr style="border:0; border-top: 2px dashed #ccc; margin: 40px 0;">

    <div class="section-title"><span class="section-icon">üìÖ</span><h2>Planung</h2></div>
    <div class="dashboard-grid">
        <div class="card">
            <h2>Neuen LKW vorplanen</h2>
            <form id="planForm">
                <input type="date" id="planDate" required style="margin-bottom:10px;">
                <input type="time" id="planTime" required style="margin-bottom:10px;">
                <input type="text" id="planSpedition" placeholder="Spedition" required style="margin-bottom:10px;">
                <input type="text" id="planPlate" placeholder="Kennzeichen" style="margin-bottom:10px;">
                <input type="text" id="planWare" placeholder="Ware" required style="margin-bottom:10px;">
                <select id="planType" style="margin-bottom:10px;">
                    <option value="Anlieferung">Anlieferung</option>
                    <option value="Abholung">Abholung</option>
                </select>
                <button type="submit" class="btn btn-success" style="width:100%">Einplanen</button>
            </form>
        </div>
        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="card">
                <h2 style="color:#2563eb;">üî• Heute (<span id="dateDisplayToday"></span>)</h2>
                <table id="planTableToday">
                    <thead><tr><th>Zeit</th><th>Status</th><th>Spedition</th><th>Aktion</th></tr></thead>
                    <tbody></tbody>
                </table>
                <p id="noTodayMsg" style="text-align:center; color:#999; display:none;">Nichts geplant.</p>
            </div>
            <div class="card" style="background-color:#f8fafc;">
                <h2 style="color:#6366f1;">üîú Zukunft</h2>
                <table id="planTableFuture">
                    <thead><tr><th>Datum</th><th>Spedition</th><th>Aktion</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // -----------------------------------------------------------
    // 1. HIER DEINE DATEN VON FIREBASE EINF√úGEN!
    // -----------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "HIER_API_KEY_EINF√úGEN",
        authDomain: "HIER_PROJEKT_ID.firebaseapp.com",
        databaseURL: "https://HIER_PROJEKT_ID-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "HIER_PROJEKT_ID",
        storageBucket: "HIER_PROJEKT_ID.appspot.com",
        messagingSenderId: "123...",
        appId: "1:..."
    };
    
    // -----------------------------------------------------------
    // Ab hier nichts mehr √§ndern
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Globale Variablen f√ºr Daten
    let lkwLog = [];
    let lkwPlan = [];
    let myChart = null;
    const EMAIL_RECIPIENT = "alexander.kellner@haertecenter.de";

    // --- CHART INITIALISIEREN ---
    function initChart() {
        const ctx = document.getElementById('frequencyChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Anzahl LKW',
                    data: [],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- DATEN LADEN (LIVE LISTENER) ---
    // Das hier passiert AUTOMATISCH, wenn irgendwo auf der Welt jemand was √§ndert
    
    // Log Daten h√∂ren
    onValue(ref(db, 'logs'), (snapshot) => {
        lkwLog = [];
        const data = snapshot.val();
        if(data) {
            // Umwandeln von Objekt {key: val} in Array [{id: key, ...val}]
            Object.keys(data).forEach(key => {
                lkwLog.push({ id: key, ...data[key] });
            });
        }
        renderAll();
    });

    // Plan Daten h√∂ren
    onValue(ref(db, 'plans'), (snapshot) => {
        lkwPlan = [];
        const data = snapshot.val();
        if(data) {
            Object.keys(data).forEach(key => {
                lkwPlan.push({ id: key, ...data[key] });
            });
        }
        renderAll();
    });

    // --- SPEICHERN (In Cloud schieben) ---
    
    window.addLog = (e) => {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        
        // Senden an Firebase
        push(ref(db, 'logs'), entry);
        
        document.getElementById('logForm').reset();
        setNow('logTime');
    };

    window.addPlan = (e) => {
        e.preventDefault();
        const entry = getFormData('plan');
        entry.notified = false;
        
        // Senden an Firebase
        push(ref(db, 'plans'), entry);
        
        document.getElementById('planForm').reset();
        document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    };

    // --- L√ñSCHEN & UPDATEN ---

    window.deleteLog = (id) => {
        if(confirm("L√∂schen?")) remove(ref(db, 'logs/' + id));
    };

    window.deletePlan = (id) => {
        if(confirm("L√∂schen?")) remove(ref(db, 'plans/' + id));
    };

    window.checkIn = (id) => {
        // Finde Element im lokalen Array, um Daten zu kopieren
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;

        const now = new Date();
        const timeStr = now.toTimeString().substring(0,5);
        const dateStr = now.toISOString().split('T')[0];

        const logEntry = {
            spedition: item.spedition,
            plate: item.plate,
            ware: item.ware,
            type: item.type,
            date: dateStr,
            time: timeStr,
            shift: calculateShift(timeStr)
        };

        // 1. In Log schreiben
        push(ref(db, 'logs'), logEntry);
        // 2. Aus Plan l√∂schen
        remove(ref(db, 'plans/' + id));
    };

    window.sendLateMail = (id) => {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;
        const subject = `VERZUG: LKW ${item.spedition}`;
        const body = `LKW √ºberf√§llig:\n${item.spedition}, ${item.time} Uhr.`;
        location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };

    // --- HELPER ---
    function getFormData(prefix) {
        // Bei Plan gibt es ein Datum-Feld, bei Log nicht (ist immer heute)
        const dateEl = document.getElementById(prefix + 'Date');
        
        return {
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '-',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value,
            date: dateEl ? dateEl.value : null 
        };
    }

    function calculateShift(timeStr) {
        const h = parseInt(timeStr.split(':')[0]);
        if (h >= 6 && h < 14) return "Fr√ºh";
        if (h >= 14 && h < 22) return "Sp√§t";
        return "Nacht";
    }

    function setNow(id) {
        document.getElementById(id).value = new Date().toTimeString().substring(0,5);
    }

    // --- RENDERING (UI) ---
    function renderAll() {
        renderLogTable();
        renderPlanTables();
        calculateStats();
        updateChart();
    }

    function renderLogTable() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        
        // Sortieren
        const sorted = [...lkwLog].sort((a,b) => b.time.localeCompare(a.time));

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return;
            const badgeClass = entry.type === 'Anlieferung' ? 'in' : 'out';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${entry.time}</strong></td>
                <td><span class="badge ${badgeClass}">${entry.type}</span></td>
                <td>${entry.spedition}</td><td>${entry.plate}</td>
                <td><button onclick="deleteLog('${entry.id}')" class="btn btn-danger btn-small">X</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderPlanTables() {
        const tbodyToday = document.querySelector('#planTableToday tbody');
        const tbodyFuture = document.querySelector('#planTableFuture tbody');
        tbodyToday.innerHTML = ''; tbodyFuture.innerHTML = '';
        
        const todayStr = new Date().toISOString().split('T')[0];
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        const sorted = [...lkwPlan].sort((a,b) => {
            if(a.date !== b.date) return a.date.localeCompare(b.date);
            return a.time.localeCompare(b.time);
        });

        let cToday = 0, cFuture = 0;

        sorted.forEach(entry => {
            if(entry.date === todayStr) {
                cToday++;
                const [h, m] = entry.time.split(':').map(Number);
                const isLate = currentMinutes > (h*60+m);
                
                const tr = document.createElement('tr');
                tr.className = isLate ? 'row-overdue' : 'row-planned';
                
                let btn = isLate 
                    ? `<button onclick="checkIn('${entry.id}')" class="btn btn-success btn-small">Ist da</button> <button onclick="sendLateMail('${entry.id}')" class="btn btn-mail btn-small">Mail</button>`
                    : `<button onclick="checkIn('${entry.id}')" class="btn btn-success btn-small">Ist da</button> <button onclick="deletePlan('${entry.id}')" class="btn btn-danger btn-small">L√∂schen</button>`;
                
                tr.innerHTML = `<td>${entry.time}</td><td>${isLate?'‚ö†Ô∏è':'Geplant'}</td><td>${entry.spedition}</td><td>${btn}</td>`;
                tbodyToday.appendChild(tr);
            } else if (entry.date > todayStr) {
                cFuture++;
                const tr = document.createElement('tr');
                tr.className = 'row-future';
                tr.innerHTML = `<td>${new Date(entry.date).toLocaleDateString()}</td><td>${entry.spedition}</td><td><button onclick="deletePlan('${entry.id}')" class="btn btn-danger btn-small">X</button></td>`;
                tbodyFuture.appendChild(tr);
            }
        });
        
        document.getElementById('noTodayMsg').style.display = cToday===0?'block':'none';
    }

    function calculateStats() {
        let early=0, late=0, hours={};
        const todayStr = new Date().toISOString().split('T')[0];
        lkwLog.forEach(e => {
            if(e.date === todayStr) {
                if(e.shift==='Fr√ºh') early++; 
                if(e.shift==='Sp√§t') late++;
                const h = parseInt(e.time.split(':')[0]);
                hours[h] = (hours[h]||0)+1;
            }
        });
        let max=0, peak='-';
        for(let[h,c] of Object.entries(hours)) { if(c>max){max=c; peak=`${h}-${parseInt(h)+1}h`;}}
        document.getElementById('stat-early').textContent = early;
        document.getElementById('stat-late').textContent = late;
        document.getElementById('stat-peak').textContent = peak;
    }

    function updateChart() {
        if(!myChart) return;
        const hours = [], data = [];
        const todayStr = new Date().toISOString().split('T')[0];
        for(let i=6; i<=22; i++) hours.push(i.toString().padStart(2,'0')+' Uhr');
        const counts = {};
        lkwLog.forEach(e => {
            if(e.date === todayStr) {
                const h = parseInt(e.time.split(':')[0]);
                counts[h] = (counts[h]||0)+1;
            }
        });
        for(let i=6; i<=22; i++) data.push(counts[i]||0);
        myChart.data.labels = hours;
        myChart.data.datasets[0].data = data;
        myChart.update();
    }

    // Init
    document.getElementById('logForm').addEventListener('submit', window.addLog);
    document.getElementById('planForm').addEventListener('submit', window.addPlan);
    initChart();
    setNow('logTime');
    const d = new Date().toLocaleDateString();
    document.getElementById('dateDisplayToday').textContent = d;
    document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    
    // Auto-Refresh f√ºr "Versp√§tet"-Status (visuell)
    setInterval(renderPlanTables, 60000); 

</script>
</body>
</html>